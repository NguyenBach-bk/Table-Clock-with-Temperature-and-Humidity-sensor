C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE 8051_DIGITAL_CLOCK
OBJECT MODULE PLACED IN .\Objects\8051_Digital_Clock.obj
COMPILER INVOKED BY: D:\Chuong trinh\KeilC_v5\C51\BIN\C51.EXE 8051_Digital_Clock.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECT
                    -EXTEND PRINT(.\Listings\8051_Digital_Clock.lst) TABS(2) OBJECT(.\Objects\8051_Digital_Clock.obj)

line level    source

   1          #include <REGX52.H>
   2          #include "..\Lib\Delay.h"
   3          #include "..\Lib\Lcd_16_2.h"
   4          #include "..\Lib\I2C.h"
   5          #include "..\Lib\DS1307.h"
   6          #include "..\Lib\DHT11.h"
   7          
   8          unsigned char hour, minute, second, old_sec = 60;
   9          unsigned char day, date, month, year;
  10          unsigned char I_RH, D_RH, I_TEMP, D_TEMP, checksum;
  11          unsigned char set_hr, set_min, set_sec;
  12          unsigned char set_day, set_date, set_mon, set_yr;
  13          unsigned char mode = 0, clear_scr = 0, update_scr = 0;
  14          
  15          sbit MODE = P1^4;
  16          sbit BTN1 = P1^5;
  17          sbit BTN2 = P1^6;
  18          sbit BTN3 = P1^7;
  19          
  20          void MODE_BTN()
  21          {
  22   1        if(MODE == 0)
  23   1          {
  24   2            Delay_ms(20);
  25   2            if(MODE == 1)
  26   2            {
  27   3              clear_scr = 0;
  28   3              mode++;
  29   3              if(mode == 1)
  30   3                update_scr = 0;
  31   3              if(mode == 2)
  32   3                update_scr = 2;
  33   3            }
  34   2            
  35   2            if(mode >= 3)
  36   2            {
  37   3              clear_scr = 0;
  38   3              update_scr = 0;
  39   3              mode = 0;
  40   3            }
  41   2          }
  42   1      }
  43          
  44          void SET_TIME()
  45          {
  46   1        if(BTN1 == 0)
  47   1          {
  48   2            Delay_ms(20);
  49   2            if(BTN1 == 1)
  50   2              {
  51   3               set_hr++;
  52   3               update_scr--;
  53   3              }
  54   2          }
C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 2   

  55   1        
  56   1        if(set_hr >= 24)
  57   1          {
  58   2            set_hr = 0;
  59   2          }
  60   1              
  61   1        if(BTN2 == 0)
  62   1          {
  63   2            Delay_ms(20);
  64   2            if(BTN2 == 1)
  65   2              {
  66   3               set_min++;
  67   3               update_scr--;
  68   3              }
  69   2          }
  70   1        
  71   1        if(set_min >= 60)
  72   1          {
  73   2            set_min = 0;
  74   2          }
  75   1          
  76   1      }
  77          
  78          void SET_CAL() 
  79          {
  80   1          unsigned char days_in_month;
  81   1      
  82   1          if (set_mon == 2) 
  83   1          { 
  84   2              if ((set_yr % 4 == 0) && (set_yr != 0)) 
  85   2              {
  86   3                  days_in_month = 29;
  87   3              } else 
  88   2              {
  89   3                  days_in_month = 28;
  90   3              }
  91   2          } 
  92   1          else if (set_mon == 4 || set_mon == 6 || set_mon == 9 || set_mon == 11) 
  93   1          {
  94   2              days_in_month = 30;
  95   2          } 
  96   1          else 
  97   1          {
  98   2              days_in_month = 31;
  99   2          }
 100   1      
 101   1          if (BTN1 == 0) 
 102   1          {
 103   2              Delay_ms(20);
 104   2              if (BTN1 == 1) 
 105   2              {
 106   3                  set_date++;
 107   3                  update_scr--;
 108   3                  if (set_date > days_in_month) 
 109   3                  {
 110   4                      set_date = 1;
 111   4                  }
 112   3              }
 113   2          }
 114   1      
 115   1          if (BTN2 == 0) 
 116   1          {
C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 3   

 117   2              Delay_ms(20);
 118   2              if (BTN2 == 1)
 119   2              {
 120   3                  set_mon++;
 121   3                  update_scr--;
 122   3                  if (set_mon > 12) 
 123   3                  {
 124   4                      set_mon = 1;
 125   4                  }
 126   3              }
 127   2          }
 128   1      
 129   1          if (BTN3 == 0) 
 130   1          {
 131   2              Delay_ms(20);
 132   2              if (BTN3 == 1) 
 133   2              {
 134   3                  set_yr++;
 135   3                  update_scr--;
 136   3                  if (set_yr > 99) 
 137   3                  {
 138   4                      set_yr = 0;
 139   4                  }
 140   3              }
 141   2          }
 142   1      }
 143          
 144          void RETURN()
 145          {
 146   1        if(BTN3 == 0)
 147   1          {
 148   2            Delay_ms(20);
 149   2            if(BTN3 == 1)
 150   2            {
 151   3              clear_scr = 0;
 152   3              update_scr = 0;
 153   3              mode = 0;
 154   3            }
 155   2          }
 156   1      }
 157          
 158          void main()
 159          {
 160   1          P3_6 = 0;
 161   1          P3_7 = 0;
 162   1          LCD_Init(); // Move this outside the loop
 163   1          while(1)
 164   1          {
 165   2            while(mode == 0)
 166   2            {
 167   3              MODE_BTN(); 
 168   3              
 169   3              if(P3_6 == 1)
 170   3                P3_7 = 1;
 171   3              else
 172   3                P3_7 = 0;
 173   3              
 174   3              MODE_BTN(); 
 175   3              
 176   3              if(clear_scr == 0)
 177   3              {
 178   4                LCD_Clear();
C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 4   

 179   4                Delay_ms(10);
 180   4                clear_scr = 1;
 181   4              }
 182   3              
 183   3              MODE_BTN(); 
 184   3              
 185   3              DS1307_Read_Time(&hour, &minute, &second); // Use pointers
 186   3              DS1307_Read_Date(&day, &date, &month, &year);
 187   3              
 188   3              MODE_BTN(); 
 189   3              
 190   3              if(second != old_sec)
 191   3              { 
 192   4              MODE_BTN(); 
 193   4              
 194   4              LCD_Gotoxy(0, 0);
 195   4              LCD_Puts("  ");
 196   4              LCD_Gotoxy(10, 0);
 197   4              LCD_Puts("  ");
 198   4              LCD_Gotoxy(15, 0);
 199   4              LCD_Puts(" ");
 200   4                
 201   4              MODE_BTN(); 
 202   4                
 203   4              LCD_Gotoxy(0, 1);
 204   4              LCD_Puts("  ");
 205   4              LCD_Gotoxy(10, 1);
 206   4              LCD_Puts("  ");
 207   4              LCD_Gotoxy(15, 1);
 208   4              LCD_Puts(" ");
 209   4                
 210   4              MODE_BTN();
 211   4                
 212   4              LCD_Gotoxy(2, 0);
 213   4              LCD_PutChar(hour / 10 + '0'); // Convert to ASCII
 214   4              LCD_PutChar(hour % 10 + '0');
 215   4              LCD_PutChar(':');
 216   4              LCD_PutChar(minute / 10 + '0');
 217   4                
 218   4              MODE_BTN();
 219   4                
 220   4              LCD_PutChar(minute % 10 + '0');
 221   4              LCD_PutChar(':');
 222   4              LCD_PutChar(second / 10 + '0');
 223   4              LCD_PutChar(second % 10 + '0');
 224   4              
 225   4              MODE_BTN();
 226   4                
 227   4              LCD_Gotoxy(2, 1);
 228   4              LCD_PutChar(date / 10 + '0'); // Convert to ASCII
 229   4              LCD_PutChar(date % 10 + '0');
 230   4              LCD_PutChar('/');
 231   4              LCD_PutChar(month / 10 + '0');
 232   4              
 233   4              MODE_BTN();
 234   4              
 235   4              LCD_PutChar(month % 10 + '0');
 236   4              LCD_PutChar('/');
 237   4              LCD_PutChar(year / 10 + '0');
 238   4              LCD_PutChar(year % 10 + '0');
 239   4              
 240   4              MODE_BTN();
C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 5   

 241   4              
 242   4              Request();
 243   4              Response();
 244   4              I_RH     = Receive_data();
 245   4              D_RH     = Receive_data();
 246   4              I_TEMP   = Receive_data();
 247   4              D_TEMP   = Receive_data();
 248   4              checksum = Receive_data();
 249   4              
 250   4              MODE_BTN();
 251   4              
 252   4              LCD_Gotoxy(12, 0);
 253   4              LCD_PutChar(I_TEMP/10+48);
 254   4              LCD_PutChar(I_TEMP%10+48);
 255   4              LCD_PutChar('C');
 256   4              
 257   4              MODE_BTN();
 258   4              
 259   4              LCD_Gotoxy(12, 1);
 260   4              LCD_PutChar(I_RH/10+48);
 261   4              LCD_PutChar(I_RH%10+48);
 262   4              LCD_PutChar('%');
 263   4              
 264   4              set_hr = hour; set_min = minute; set_sec = second;
 265   4              set_day = day; set_date = date; set_mon = month; set_yr = year;
 266   4              
 267   4              old_sec = second;
 268   4              
 269   4              MODE_BTN();
 270   4              }
 271   3            }
 272   2            
 273   2            while(mode == 1)
 274   2            {
 275   3              MODE_BTN();
 276   3              SET_TIME();
 277   3              RETURN();
 278   3              
 279   3              if(P3_6 == 1)
 280   3                P3_7 = 1;
 281   3              else
 282   3                P3_7 = 0;
 283   3              
 284   3              MODE_BTN();
 285   3              SET_TIME();
 286   3              RETURN();
 287   3              
 288   3              if(clear_scr == 0)
 289   3              {
 290   4                LCD_Clear();
 291   4                Delay_ms(10);
 292   4                clear_scr = 1;
 293   4              }
 294   3              
 295   3              MODE_BTN();
 296   3              SET_TIME();
 297   3              RETURN();
 298   3              
 299   3              while(update_scr == 0)
 300   3              {
 301   4                LCD_Gotoxy(4, 0);
 302   4                LCD_Puts("SET TIME");
C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 6   

 303   4                LCD_Gotoxy(2, 1);
 304   4                LCD_Puts("HR:");
 305   4                LCD_PutChar(set_hr / 10 + '0');
 306   4                LCD_PutChar(set_hr % 10 + '0');
 307   4                LCD_Gotoxy(9, 1);
 308   4                LCD_Puts("MN:");
 309   4                LCD_PutChar(set_min / 10 + '0');
 310   4                LCD_PutChar(set_min % 10 + '0');  
 311   4                DS1307_Write_Time(set_hr, set_min, 0);
 312   4                update_scr = 1;
 313   4              }
 314   3            }
 315   2            
 316   2            while(mode == 2)
 317   2            {
 318   3              MODE_BTN();
 319   3              SET_CAL();
 320   3              
 321   3              if(P3_6 == 1)
 322   3                P3_7 = 1;
 323   3              else
 324   3                P3_7 = 0;
 325   3              
 326   3              MODE_BTN();
 327   3              SET_CAL();
 328   3              
 329   3              if(clear_scr == 0)
 330   3              {
 331   4                LCD_Clear();
 332   4                Delay_ms(10);
 333   4                clear_scr = 1;
 334   4              }
 335   3              
 336   3              MODE_BTN();
 337   3              SET_CAL();
 338   3              
 339   3              while(update_scr == 2)
 340   3              {
 341   4                LCD_Gotoxy(1, 0);
 342   4                LCD_Puts("SET DATE");
 343   4                LCD_Gotoxy(11, 0);
 344   4                LCD_Puts("DY:");
 345   4                LCD_PutChar(set_date / 10 + '0');
 346   4                LCD_PutChar(set_date % 10 + '0');
 347   4                LCD_Gotoxy(3, 1);
 348   4                LCD_Puts("MT:");
 349   4                LCD_PutChar(set_mon / 10 + '0');
 350   4                LCD_PutChar(set_mon % 10 + '0');
 351   4                LCD_Gotoxy(10, 1);
 352   4                LCD_Puts("YR:");
 353   4                LCD_PutChar(set_yr / 10 + '0');
 354   4                LCD_PutChar(set_yr % 10 + '0');
 355   4                DS1307_Write_Date(1, set_date, set_mon, set_yr);
 356   4                update_scr = 3;
 357   4              }
 358   3            }
 359   2         }
 360   1      }
 361          
 362          #endif


C51 COMPILER V9.60.7.0   8051_DIGITAL_CLOCK                                                10/15/2024 23:12:06 PAGE 7   

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1230    ----
   CONSTANT SIZE    =     43    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
